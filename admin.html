<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SheerID Verify - Aplikasi Admin</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic buttons and main container (DARK THEME) */
        :root {
            --primary: #8b5cf6; /* Violet 500 */
            --secondary: #374151; /* Gray 700 */
            --text-color: #f3f4f6; /* Gray 100 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Gray 800 */
            color: var(--text-color);
        }
        .btn-primary {
            background-color: var(--primary);
            color: #1f2937; /* Dark text on bright button */
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #7c3aed; /* Violet 600 */
            transform: translateY(-1px);
        }
        .card {
            background-color: #374151; /* Gray 700 for cards */
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.2);
            max-width: 100%;
        }
        /* Status Colors for Dark Theme */
        .status-loading { background-color: #4a341b; color: #facc15; } /* Dark Amber/Yellow */
        
        .input-field {
            padding: 0.75rem;
            background-color: #1f2937; /* Gray 800 */
            border: 1px solid #4b5563; /* Gray 600 */
            border-radius: 0.5rem;
            width: 100%;
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-field:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3); /* Violet shadow */
        }
        
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header & Navigation -->
    <header class="bg-gray-900 shadow-xl p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-100 flex items-center">
                <i data-lucide="shield-check" class="w-6 h-6 text-red-400 mr-2"></i>
                SheerID Verify - **ADMIN**
            </h1>
            <nav>
                <button id="nav-logout" class="text-sm font-medium text-red-400 hover:text-red-500 px-3 py-1 rounded transition hidden" onclick="handleLogout()">
                    <i data-lucide="log-out" class="w-4 h-4 inline-block mr-1"></i> Logout
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8 flex justify-center items-start">
        <div id="app-container" class="w-full max-w-2xl">
            
            <!-- Views Container -->
            <div id="view-container">
                <!-- Login View -->
                <div id="view-login" class="card text-center transition-opacity duration-300">
                    <h2 class="text-xl font-semibold mb-4 text-gray-100">Login Admin</h2>
                    <p class="text-sm text-gray-400 mb-4">Masukkan kredensial Admin untuk melanjutkan.</p> 
                    <div class="space-y-4">
                        <input id="admin-user" type="text" placeholder="Username" class="input-field">
                        <input id="admin-password" type="password" placeholder="Password" class="input-field"> 
                        <button onclick="handleAdminLogin()" class="btn-primary w-full">Masuk Sebagai Admin</button>
                    </div>
                </div>

                <!-- Admin View -->
                <div id="view-admin" class="card hidden transition-opacity duration-300">
                    <h2 class="text-xl font-semibold mb-6 text-gray-100 flex items-center">
                        <i data-lucide="clipboard-check" class="w-5 h-5 mr-2 text-red-400"></i> Panel Persetujuan Admin
                    </h2>
                    
                    <!-- Code Generation Section -->
                    <div class="mb-6 p-4 bg-gray-800 rounded-lg border border-red-500">
                        <h3 class="text-lg font-semibold text-gray-100 mb-3">Generator Kode Khusus</h3>
                        <p class="text-sm text-gray-300 mb-3">Buat kode khusus untuk pengguna (salin dan berikan kepada pengguna):</p>
                        
                        <div class="flex flex-wrap gap-3 mb-4">
                            <button onclick="generateCode('10X')" class="flex-1 min-w-[30%] bg-violet-600 hover:bg-violet-700 text-gray-900 text-sm font-medium py-2 px-4 rounded-lg transition">
                                <i data-lucide="repeat-2" class="w-4 h-4 inline-block mr-1"></i> Generate 10x
                            </button>
                            <button onclick="generateCode('5X')" class="flex-1 min-w-[30%] bg-cyan-600 hover:bg-cyan-700 text-gray-900 text-sm font-medium py-2 px-4 rounded-lg transition">
                                <i data-lucide="repeat-1" class="w-4 h-4 inline-block mr-1"></i> Generate 5x
                            </button>
                            <button onclick="generateCode('TRIAL')" class="flex-1 min-w-[30%] bg-red-400 hover:bg-red-500 text-gray-900 text-sm font-medium py-2 px-4 rounded-lg transition">
                                <i data-lucide="zap" class="w-4 h-4 inline-block mr-1"></i> Generate 1x Trial
                            </button>
                        </div>

                        <div id="generated-code-display" class="mt-3 p-3 bg-gray-700 border border-red-600 rounded-lg hidden">
                            <p class="text-red-300 font-mono text-sm break-words">Kode Baru (<span id="generated-code-type"></span>): <span id="generated-code-value"></span></p>
                            <button onclick="copyToClipboard(document.getElementById('generated-code-value').innerText)" class="mt-1 text-xs text-red-400 hover:text-red-300">Salin Kode</button>
                        </div>
                    </div>

                    <!-- Verification Requests Section -->
                    <h3 class="text-lg font-semibold text-gray-100 mb-4 border-b border-gray-600 pb-2">Permintaan Verifikasi Menunggu</h3>
                    <div id="admin-submissions-list" class="space-y-4">
                        <p id="no-requests-verify" class="text-gray-400 text-center">Tidak ada permintaan verifikasi saat ini.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL FOR CUSTOM ALERT/CONFIRMATION -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden" onclick="closeModal(event)">
        <div class="bg-gray-700 p-6 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300" onclick="event.stopPropagation()">
            <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-100"></h3>
            <p id="modal-content" class="text-gray-300 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-300 border border-gray-500 rounded-lg hover:bg-gray-600 transition hidden">Batal</button>
                <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium btn-primary" onclick="hideModal()">OK</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, updateDoc, onSnapshot, collection, query, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atur log level untuk debugging Firestore
        setLogLevel('Debug');

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAdminAuthenticated = false;

        // --- Constants ---
        const ADMIN_USER = 'admin';
        const ADMIN_PASS = 'Momok123'; // Admin credentials for local check
        const VERIFICATIONS_COLLECTION = 'verifications';

        // --- Utility Functions ---

        /**
         * Gets the Firestore collection reference for a given path.
         */
        const getPublicCollection = (collectionName) => {
            const publicCollectionPath = `artifacts/${appId}/public/data/${collectionName}`;
            return collection(db, publicCollectionPath);
        };

        const getStatusClasses = (status) => {
            switch (status) {
                case 'Approved': return 'bg-green-600';
                case 'Loading': return 'bg-yellow-600';
                case 'Rejected': return 'bg-red-600';
                default: return 'bg-gray-500';
            }
        };

        window.showModal = function(title, content, isConfirm = false, onConfirm = () => {}) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-content').innerText = content;
            
            const okBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            if (isConfirm) {
                okBtn.innerText = 'Ya, Lanjutkan';
                okBtn.onclick = () => { hideModal(); onConfirm(); };
                cancelBtn.innerText = 'Batal';
                cancelBtn.classList.remove('hidden');
            } else {
                okBtn.innerText = 'OK';
                okBtn.onclick = hideModal;
                cancelBtn.classList.add('hidden');
            }
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        window.hideModal = function() {
            document.getElementById('custom-modal').classList.add('hidden');
            document.getElementById('modal-confirm-btn').onclick = hideModal;
            document.getElementById('modal-cancel-btn').classList.add('hidden');
        }

        window.closeModal = function(event) {
             if (event.target.id === 'custom-modal') { hideModal(); }
        }
        
        window.copyToClipboard = function(text) {
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showModal("Berhasil Disalin", "Teks/Kode/Link telah disalin ke clipboard!");
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showModal("Gagal Menyalin", "Gagal menyalin. Silakan salin secara manual: " + text);
            }
        }

        // --- UI Rendering & State Management ---

        window.showView = function(viewName) {
            const views = ['login', 'admin'];
            views.forEach(view => {
                const el = document.getElementById(`view-${view}`);
                if (el) {
                    el.classList.add('hidden');
                }
            });
            
            const targetEl = document.getElementById(`view-${viewName}`);
            if (targetEl) {
                targetEl.classList.remove('hidden');
            }
            
            // Manage Navigation
            document.getElementById('nav-logout').classList.toggle('hidden', viewName !== 'admin');
            
            lucide.createIcons();
        }

        function renderAdminSubmissions(verifications) {
            const listEl = document.getElementById('admin-submissions-list');
            listEl.innerHTML = ''; 
            
            // Only show requests that are 'Loading' and not 'Resolved'
            const loadingRequests = verifications.filter(v => v.status === 'Loading').sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
            
            if (loadingRequests.length === 0) {
                document.getElementById('no-requests-verify').classList.remove('hidden');
                return;
            }
            document.getElementById('no-requests-verify').classList.add('hidden');


            loadingRequests.forEach(req => {
                const date = req.timestamp ? new Date(req.timestamp.seconds * 1000).toLocaleString('id-ID') : 'N/A';
                const item = document.createElement('div');
                item.className = 'p-4 rounded-lg border-l-4 border-red-500 shadow-lg bg-gray-800 space-y-2';
                item.innerHTML = `
                    <p class="text-xs font-semibold uppercase ${getStatusClasses(req.status)} text-gray-900 inline-block px-2 py-0.5 rounded-full">Status: ${req.status}</p>
                    <p class="text-sm text-gray-300 break-words"><strong>User ID:</strong> <span class="font-mono text-xs">${req.userId}</span></p>
                    <p class="text-sm text-gray-300 break-words"><strong>Kode:</strong> <span class="font-mono">${req.code}</span></p>
                    
                    <div class="flex items-center space-x-2">
                        <p class="text-sm text-gray-300 break-words"><strong>Link SheerID:</strong> 
                            <a href="${req.sheerIdLink}" target="_blank" class="text-red-400 hover:underline break-all">${req.sheerIdLink}</a>
                        </p>
                        <button onclick="copyToClipboard('${req.sheerIdLink.replace(/'/g, "\\'")}')" class="flex-shrink-0 text-red-300 hover:text-red-400 text-xs p-1 rounded-md bg-gray-700 transition" title="Salin Link">
                            <i data-lucide="copy" class="w-3 h-3 inline-block"></i> Salin Link
                        </button>
                    </div>

                    <p class="text-xs text-gray-400">Dikirim: ${date}</p>
                    <div class="pt-2 border-t border-gray-600 mt-2 flex space-x-2">
                        <button onclick="handleApprove('${req.id}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition">
                            <i data-lucide="check" class="w-4 h-4 inline-block mr-1"></i> ACC
                        </button>
                        <button onclick="handleReject('${req.id}')" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-gray-900 text-sm font-medium py-2 px-4 rounded-lg transition">
                            <i data-lucide="x" class="w-4 h-4 inline-block mr-1"></i> Tolak
                        </button>
                        <button onclick="handleDeleteConfirm('${req.id}')" class="flex-1 bg-red-700 hover:bg-red-800 text-white text-sm font-medium py-2 px-4 rounded-lg transition">
                            <i data-lucide="trash-2" class="w-4 h-4 inline-block mr-1"></i> Hapus
                        </button>
                    </div>
                `;
                listEl.appendChild(item);
                lucide.createIcons();
            });
        }


        // --- Auth & Init ---

        async function initializeAndAuthenticate() {
            if (!firebaseConfig) {
                 console.error("Firebase config is missing.");
                 showModal("Error", "Konfigurasi Firebase tidak ditemukan. Aplikasi tidak dapat berjalan.");
                 return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Use custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        const storedRole = localStorage.getItem('sheerid_role_admin');
                        if (storedRole === 'true') {
                            isAdminAuthenticated = true;
                            showView('admin');
                            setupListeners();
                        } else {
                            isAdminAuthenticated = false;
                            showView('login');
                        }
                    } else {
                        isAdminAuthenticated = false;
                        showView('login');
                    }
                });
                
            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                showModal("Error Fatal", "Gagal menginisialisasi Firebase: " + error.message);
            }
        }

        window.handleAdminLogin = function() {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-password').value;
            
            document.getElementById('admin-user').value = '';
            document.getElementById('admin-password').value = '';

            // Simple local authentication check
            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                isAdminAuthenticated = true;
                localStorage.setItem('sheerid_role_admin', 'true'); 
                showView('admin');
                showModal("Login Sukses", "Anda berhasil masuk sebagai Admin.");
                setupListeners(); 
            } else {
                showModal("Login Gagal", "Username atau Password salah.");
            }
        }

        window.handleLogout = function() {
            isAdminAuthenticated = false;
            localStorage.removeItem('sheerid_role_admin');
            showView('login');
        }

        // --- Firestore Listeners & Operations ---

        function setupListeners() {
            if (!db || !isAdminAuthenticated) return;

            const verificationsRef = getPublicCollection(VERIFICATIONS_COLLECTION);
            
            // Admin Listener (All verifications)
            onSnapshot(verificationsRef, (snapshot) => {
                const verifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminSubmissions(verifications);
            }, (error) => {
                console.error("Admin Verify Listener Error:", error);
            });
        }


        // --- Admin Action Functions ---

        window.handleApprove = function(docId) {
             showModal(
                "Konfirmasi Persetujuan",
                "Apakah Anda yakin ingin MENYETUJUI permintaan verifikasi ini? Status pengguna akan menjadi 'Approved'.",
                true,
                async () => {
                    const verificationsRef = getPublicCollection(VERIFICATIONS_COLLECTION);
                    try {
                        await updateDoc(doc(verificationsRef, docId), {
                            status: 'Approved',
                            adminActionTimestamp: serverTimestamp()
                        });
                        showModal("Aksi Sukses", "Permintaan berhasil disetujui. Pengguna akan melihat status 'Verifikasi Sukses'.");
                    } catch (e) {
                        console.error("Error approving request: ", e);
                        showModal("Kesalahan", "Gagal menyetujui permintaan: " + e.message);
                    }
                }
            );
        }

        window.handleReject = function(docId) {
             showModal(
                "Konfirmasi Penolakan",
                "Apakah Anda yakin ingin MENOLAK permintaan verifikasi ini? Status pengguna akan menjadi 'Rejected'.",
                true,
                async () => {
                    const verificationsRef = getPublicCollection(VERIFICATIONS_COLLECTION);
                    try {
                        await updateDoc(doc(verificationsRef, docId), {
                            status: 'Rejected',
                            adminActionTimestamp: serverTimestamp()
                        });
                        showModal("Aksi Sukses", "Permintaan berhasil ditolak. Pengguna akan melihat status 'Verifikasi Ditolak'.");
                    } catch (e) {
                        console.error("Error rejecting request: ", e);
                        showModal("Kesalahan", "Gagal menolak permintaan: " + e.message);
                    }
                }
            );
        }

        window.handleDeleteConfirm = function(docId) {
             showModal(
                "Konfirmasi Hapus",
                "Apakah Anda yakin ingin MENGHAPUS permanen permintaan ini? Data akan hilang dan tidak dapat dikembalikan.",
                true,
                () => handleDelete(docId) 
            );
        }

        window.handleDelete = async function(docId) {
            const verificationsRef = getPublicCollection(VERIFICATIONS_COLLECTION);
            try {
                await deleteDoc(doc(verificationsRef, docId));
                showModal("Aksi Sukses", "Permintaan berhasil dihapus.");
            } catch (e) {
                console.error("Error deleting request: ", e);
                showModal("Kesalahan", "Gagal menghapus permintaan: " + e.message);
            }
        }
        
        /**
         * Generates and displays a specific code type.
         */
        window.generateCode = function(type) {
            let prefix;
            let label;
            if (type === '10X') {
                prefix = 'SID-10X-';
                label = 'Durasi 10x';
            } else if (type === '5X') {
                prefix = 'SID-5X-';
                label = 'Durasi 5x';
            } else if (type === 'TRIAL') {
                prefix = 'SID-TRIAL-1X-';
                label = 'Trial (1x Pakai)';
            } else {
                prefix = 'SID-';
                label = 'Normal';
            }
            
            // Generate random alphanumeric suffix
            const codeValue = prefix + Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('generated-code-value').innerText = codeValue;
            document.getElementById('generated-code-type').innerText = label;
            document.getElementById('generated-code-display').classList.remove('hidden');
        }

        // --- Start Application ---
        initializeAndAuthenticate();
        
    </script>
</body>
</html>

